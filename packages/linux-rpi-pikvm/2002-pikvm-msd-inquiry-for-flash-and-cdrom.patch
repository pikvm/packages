From 38cea64f6c055c38e80720832b973c7ecab191f7 Mon Sep 17 00:00:00 2001
From: Maxim Devaev <mdevaev@gmail.com>
Date: Sat, 1 Nov 2025 16:24:34 +0200
Subject: [PATCH] pikvm: msd: inquiry for flash and cdrom

---
 drivers/usb/gadget/function/f_mass_storage.c | 21 +++++++++-
 drivers/usb/gadget/function/storage_common.c | 41 ++++++++++++++++----
 drivers/usb/gadget/function/storage_common.h |  4 ++
 3 files changed, 57 insertions(+), 9 deletions(-)

diff --git a/drivers/usb/gadget/function/f_mass_storage.c b/drivers/usb/gadget/function/f_mass_storage.c
index 08e0d1c511e8..47cbfd3a468f 100644
--- a/drivers/usb/gadget/function/f_mass_storage.c
+++ b/drivers/usb/gadget/function/f_mass_storage.c
@@ -1071,7 +1071,10 @@ static int do_inquiry(struct fsg_common *common, struct fsg_buffhd *bh)
 	buf[5] = 0;		/* No special options */
 	buf[6] = 0;
 	buf[7] = 0;
-	if (curlun->inquiry_string[0])
+	if (curlun->cdrom && curlun->inquiry_string_cdrom[0])
+		memcpy(buf + 8, curlun->inquiry_string_cdrom,
+		       sizeof(curlun->inquiry_string_cdrom));
+	else if (curlun->inquiry_string[0])
 		memcpy(buf + 8, curlun->inquiry_string,
 		       sizeof(curlun->inquiry_string));
 	else
@@ -3250,6 +3253,21 @@ static ssize_t fsg_lun_opts_inquiry_string_store(struct config_item *item,
 
 CONFIGFS_ATTR(fsg_lun_opts_, inquiry_string);
 
+static ssize_t fsg_lun_opts_inquiry_string_cdrom_show(struct config_item *item,
+						      char *page)
+{
+	return fsg_show_inquiry_string_cdrom(to_fsg_lun_opts(item)->lun, page);
+}
+
+static ssize_t fsg_lun_opts_inquiry_string_cdrom_store(struct config_item *item,
+						       const char *page, size_t len)
+{
+	return fsg_store_inquiry_string_cdrom(to_fsg_lun_opts(item)->lun,
+					      page, len);
+}
+
+CONFIGFS_ATTR(fsg_lun_opts_, inquiry_string_cdrom);
+
 static ssize_t fsg_lun_opts_forced_eject_store(struct config_item *item,
 					       const char *page, size_t len)
 {
@@ -3269,6 +3287,7 @@ static struct configfs_attribute *fsg_lun_attrs[] = {
 	&fsg_lun_opts_attr_cdrom,
 	&fsg_lun_opts_attr_nofua,
 	&fsg_lun_opts_attr_inquiry_string,
+	&fsg_lun_opts_attr_inquiry_string_cdrom,
 	&fsg_lun_opts_attr_forced_eject,
 	NULL,
 };
diff --git a/drivers/usb/gadget/function/storage_common.c b/drivers/usb/gadget/function/storage_common.c
index 75831f2c7abe..04aa42bb8999 100644
--- a/drivers/usb/gadget/function/storage_common.c
+++ b/drivers/usb/gadget/function/storage_common.c
@@ -374,6 +374,12 @@ ssize_t fsg_show_inquiry_string(struct fsg_lun *curlun, char *buf)
 }
 EXPORT_SYMBOL_GPL(fsg_show_inquiry_string);
 
+ssize_t fsg_show_inquiry_string_cdrom(struct fsg_lun *curlun, char *buf)
+{
+	return sprintf(buf, "%s\n", curlun->inquiry_string_cdrom);
+}
+EXPORT_SYMBOL_GPL(fsg_show_inquiry_string_cdrom);
+
 /*
  * The caller must hold fsg->filesem for reading when calling this function.
  */
@@ -504,24 +510,43 @@ ssize_t fsg_store_removable(struct fsg_lun *curlun, const char *buf,
 }
 EXPORT_SYMBOL_GPL(fsg_store_removable);
 
-ssize_t fsg_store_inquiry_string(struct fsg_lun *curlun, const char *buf,
-				 size_t count)
+static ssize_t _fsg_store_inquiry_string(struct fsg_lun *curlun,
+					 const char *buf, size_t count,
+					 bool cdrom)
 {
-	const size_t len = min(count, sizeof(curlun->inquiry_string));
+	char *inq_ptr = (cdrom
+			 ? curlun->inquiry_string_cdrom
+			 : curlun->inquiry_string);
+	const size_t inq_size = (cdrom
+				 ? sizeof(curlun->inquiry_string_cdrom)
+				 : sizeof(curlun->inquiry_string));
+	const size_t len = min(count, inq_size);
 
 	if (len == 0 || buf[0] == '\n') {
-		curlun->inquiry_string[0] = 0;
+		inq_ptr[0] = 0;
 	} else {
-		snprintf(curlun->inquiry_string,
-			 sizeof(curlun->inquiry_string), "%-28s", buf);
-		if (curlun->inquiry_string[len-1] == '\n')
-			curlun->inquiry_string[len-1] = ' ';
+		snprintf(inq_ptr, inq_size, "%-28s", buf);
+		if (inq_ptr[len-1] == '\n')
+			inq_ptr[len-1] = ' ';
 	}
 
 	return count;
 }
+
+ssize_t fsg_store_inquiry_string(struct fsg_lun *curlun, const char *buf,
+				 size_t count)
+{
+	return _fsg_store_inquiry_string(curlun, buf, count, false);
+}
 EXPORT_SYMBOL_GPL(fsg_store_inquiry_string);
 
+ssize_t fsg_store_inquiry_string_cdrom(struct fsg_lun *curlun, const char *buf,
+				       size_t count)
+{
+	return _fsg_store_inquiry_string(curlun, buf, count, true);
+}
+EXPORT_SYMBOL_GPL(fsg_store_inquiry_string_cdrom);
+
 ssize_t fsg_store_forced_eject(struct fsg_lun *curlun, struct rw_semaphore *filesem,
 			       const char *buf, size_t count)
 {
diff --git a/drivers/usb/gadget/function/storage_common.h b/drivers/usb/gadget/function/storage_common.h
index ced5d2b09234..7e9468548760 100644
--- a/drivers/usb/gadget/function/storage_common.h
+++ b/drivers/usb/gadget/function/storage_common.h
@@ -120,6 +120,7 @@ struct fsg_lun {
 	const char	*name;		/* "lun.name" */
 	const char	**name_pfx;	/* "function.name" */
 	char		inquiry_string[INQUIRY_STRING_LEN];
+	char		inquiry_string_cdrom[INQUIRY_STRING_LEN];
 };
 
 static inline bool fsg_lun_is_open(struct fsg_lun *curlun)
@@ -206,6 +207,7 @@ ssize_t fsg_show_nofua(struct fsg_lun *curlun, char *buf);
 ssize_t fsg_show_file(struct fsg_lun *curlun, struct rw_semaphore *filesem,
 		      char *buf);
 ssize_t fsg_show_inquiry_string(struct fsg_lun *curlun, char *buf);
+ssize_t fsg_show_inquiry_string_cdrom(struct fsg_lun *curlun, char *buf);
 ssize_t fsg_show_cdrom(struct fsg_lun *curlun, char *buf);
 ssize_t fsg_show_removable(struct fsg_lun *curlun, char *buf);
 ssize_t fsg_store_ro(struct fsg_lun *curlun, struct rw_semaphore *filesem,
@@ -219,6 +221,8 @@ ssize_t fsg_store_removable(struct fsg_lun *curlun, const char *buf,
 			    size_t count);
 ssize_t fsg_store_inquiry_string(struct fsg_lun *curlun, const char *buf,
 				 size_t count);
+ssize_t fsg_store_inquiry_string_cdrom(struct fsg_lun *curlun, const char *buf,
+				 size_t count);
 ssize_t fsg_store_forced_eject(struct fsg_lun *curlun, struct rw_semaphore *filesem,
 			       const char *buf, size_t count);
 
-- 
2.51.2

